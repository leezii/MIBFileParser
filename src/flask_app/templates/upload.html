{% extends "base.html" %}

{% block title %}Upload MIB Files{% endblock %}

{% block extra_css %}
<style>
      .upload-container {
        /* Removed max-width to use full container-fluid width */
        padding: 0;
    }

    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }

    .upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
        transform: scale(1.02);
    }

    .file-list {
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
    }

    .file-item {
        padding: 10px;
        margin: 5px 0;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: flex;
        justify-content: between;
        align-items: center;
    }

    .file-item .file-info {
        flex-grow: 1;
    }

    .file-item .file-size {
        color: #6c757d;
        font-size: 0.9em;
    }

    .device-selector {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .new-device-fields {
        margin-top: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: none;
    }

    .new-device-fields.show {
        display: block;
    }

    .progress-container {
        margin-top: 20px;
        display: none;
    }

    .progress-bar {
        height: 20px;
        background-color: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background-color: #007bff;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8em;
    }

    .results-container {
        margin-top: 20px;
        display: none;
    }

    .result-item {
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
    }

    .result-item.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .result-item.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .upload-actions {
        margin-top: 20px;
        text-align: center;
    }

    .btn-upload {
        background-color: #007bff;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
    }

    .btn-upload:hover {
        background-color: #0056b3;
    }

    .btn-upload:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .action-selector {
        margin-top: 15px;
        padding: 15px;
        background-color: #fff3cd;
        border-radius: 4px;
        border: 1px solid #ffeaa7;
    }

    .form-check {
        margin-bottom: 10px;
    }

    .alert {
        margin-top: 15px;
    }

    /* Device select options styling */
    .form-select option {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    /* Ensure device name and MIB count stay on same line */
    #deviceType {
        min-width: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-upload"></i> Upload MIB Files</h1>
            <div class="text-muted">
                <i class="fas fa-microchip"></i> Current Device: <strong>{{ current_device }}</strong>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="mb-4">

    <!-- Device Selection -->
    <div class="device-selector">
        <h5 class="mb-3">Select Device Type</h5>
        <div class="row">
            <div class="col-md-6">
                <label for="deviceType" class="form-label">Device Type:</label>
                <select class="form-select" id="deviceType" name="device_type">
                    <option value="">Select existing device...</option>
                    {% for device in devices %}
                    <option value="{{ device.name }}" {% if device.name == current_device %}selected{% endif %}>
                        {{ device.display_name }} ({{ device.mib_count }} MIBs)
                    </option>
                    {% endfor %}
                    <option value="__new__">+ Create New Device</option>
                </select>
            </div>
        </div>

        <!-- New Device Fields -->
        <div class="new-device-fields" id="newDeviceFields">
            <h6 class="mb-3">Create New Device</h6>
            <div class="row">
                <div class="col-md-6">
                    <label for="newDeviceName" class="form-label">Device Name (Internal):</label>
                    <input type="text" class="form-control" id="newDeviceName" name="new_device_name"
                           placeholder="e.g., cisco-router-2960">
                    <div class="form-text">Use lowercase letters, numbers, hyphens, and underscores only.</div>
                </div>
                <div class="col-md-6">
                    <label for="newDeviceDisplay" class="form-label">Display Name:</label>
                    <input type="text" class="form-control" id="newDeviceDisplay" name="new_device_display"
                           placeholder="e.g., Cisco Router 2960">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <label for="deviceDescription" class="form-label">Description:</label>
                    <textarea class="form-control" id="deviceDescription" name="description" rows="2"
                              placeholder="Optional description of this device type..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Action -->
    <div class="action-selector" id="actionSelector" style="display: none;">
        <h6 class="mb-3">Upload Action</h6>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="action" id="replaceAction" value="replace" checked>
            <label class="form-check-label" for="replaceAction">
                <strong>Replace Existing Files</strong> - Remove all current MIBs and upload new ones
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="action" id="appendAction" value="append">
            <label class="form-check-label" for="appendAction">
                <strong>Append to Existing Files</strong> - Add to current MIB collection
            </label>
        </div>
    </div>

    <!-- File Upload Area -->
    <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
        <h5>Drag and Drop MIB Files Here</h5>
        <p class="text-muted">or click to select files</p>
        <p class="text-muted">
            <small>Supported formats: .mib, .txt, .zip (max 50MB total)<br>
            ZIP files will be automatically extracted for MIB files</small>
        </p>
        <input type="file" id="fileInput" multiple accept=".mib,.txt,.zip" style="display: none;">
    </div>

    <!-- File List -->
    <div class="file-list" id="fileList"></div>

    <!-- Progress -->
    <div class="progress-container" id="progressContainer">
        <h6>Uploading and Processing...</h6>
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressBarFill" style="width: 0%">0%</div>
        </div>
    </div>

    <!-- Results -->
    <div class="results-container" id="resultsContainer">
        <h6>Upload Results</h6>
        <div id="resultsList"></div>
        <div class="mt-3">
            <a href="{{ url_for('main.index') }}" class="btn btn-primary">View MIBs</a>
            <a href="{{ url_for('upload.upload_page') }}" class="btn btn-secondary">Upload More Files</a>
        </div>
    </div>

    <!-- Upload Button -->
    <div class="upload-actions" id="uploadActions">
        <button type="button" class="btn-upload" id="uploadBtn" disabled>Upload Files</button>
    </div>

    <!-- Help Section -->
    <div class="mt-5">
        <h5>Help</h5>
        <div class="card">
            <div class="card-body">
                <h6>Supported File Types</h6>
                <ul>
                    <li><strong>.mib files</strong> - Standard MIB definition files</li>
                    <li><strong>.txt files</strong> - MIB files with .txt extension</li>
                    <li><strong>.zip archives</strong> - Compressed collections of MIB files</li>
                </ul>

                <h6>Device Management</h6>
                <ul>
                    <li><strong>Existing Device</strong> - Upload to an existing device type (replaces current files)</li>
                    <li><strong>New Device</strong> - Create a new device type for your uploaded files</li>
                    <li><strong>Switch Devices</strong> - Use the <a href="{{ url_for('upload.device_management') }}">Device Management</a> page to switch between device types</li>
                </ul>

                <h6>Upload Process</h6>
                <ul>
                    <li>Files are automatically validated to ensure they contain MIB content</li>
                    <li>ZIP files are extracted and filtered for MIB files</li>
                    <li>Uploaded files are parsed and added to the selected device</li>
                    <li>You can immediately view the uploaded MIBs after upload completes</li>
                </ul>
            </div>
              </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let selectedFiles = [];

    // Initialize elements
    const deviceType = $('#deviceType');
    const newDeviceFields = $('#newDeviceFields');
    const actionSelector = $('#actionSelector');

    // Device type selection
    $('#deviceType').on('change', function() {
        const value = $(this).val();

        if (value === '__new__') {
            newDeviceFields.show().addClass('show');
            actionSelector.show();
        } else if (value) {
            newDeviceFields.hide().removeClass('show');
            actionSelector.show();
        } else {
            newDeviceFields.hide().removeClass('show');
            actionSelector.hide();
        }

        validateUploadForm();
    });

    // File upload area
    const uploadArea = $('#uploadArea');
    const fileInput = $('#fileInput');
    const fileList = $('#fileList');
    const uploadBtn = $('#uploadBtn');

    // Click to upload - use direct click without jQuery event handling
    uploadArea.css('cursor', 'pointer');
    uploadArea.attr('title', 'Click to select files or drag and drop');

    // Use native click event
    if (uploadArea.length > 0 && fileInput.length > 0) {
        uploadArea[0].onclick = function() {
            fileInput[0].click();
        };
    }

    // Drag and drop
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });

    uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });

    uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');

        const files = Array.from(e.originalEvent.dataTransfer.files);
        handleFiles(files);
    });

    // File selection - use native event
    if (fileInput.length > 0) {
        fileInput[0].onchange = function() {
            const files = Array.from(this.files);
            handleFiles(files);
        };
    }

    function handleFiles(files) {
        const validFiles = files.filter(file => {
            const extension = file.name.split('.').pop().toLowerCase();
            return ['mib', 'txt', 'zip'].includes(extension);
        });

        if (validFiles.length !== files.length) {
            alert('Some files were rejected. Only .mib, .txt, and .zip files are allowed.');
        }

        selectedFiles = [...selectedFiles, ...validFiles];
        updateFileList();
        validateUploadForm();
    }

    function updateFileList() {
        fileList.empty();

        if (selectedFiles.length === 0) {
            fileList.hide();
            return;
        }

        fileList.show();
        const list = $('<div class="list-group"></div>');

        selectedFiles.forEach((file, index) => {
            const fileItem = $(`
                <div class="file-item">
                    <div class="file-info">
                        <i class="fas fa-file"></i>
                        <strong>${file.name}</strong>
                        <span class="file-size">(${formatFileSize(file.size)})</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-file" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            list.append(fileItem);
        });

        fileList.append(list);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Remove file from list
    fileList.on('click', '.remove-file', function() {
        const index = parseInt($(this).data('index'));
        selectedFiles.splice(index, 1);
        updateFileList();
        validateUploadForm();
    });

    // Validate form
    function validateUploadForm() {
        const deviceType = $('#deviceType').val();
        const hasValidDevice = deviceType && deviceType !== '';
        const hasFiles = selectedFiles.length > 0;

        if (deviceType === '__new__') {
            const newDeviceName = $('#newDeviceName').val().trim();
            uploadBtn.prop('disabled', !(newDeviceName && hasFiles));
        } else {
            uploadBtn.prop('disabled', !(hasValidDevice && hasFiles));
        }
    }

    // New device name validation
    $('#newDeviceName').on('input', validateUploadForm);

    // Upload button click
    uploadBtn.on('click', function() {
        uploadFiles();
    });

    function uploadFiles() {
        const deviceType = $('#deviceType').val();
        const action = $('input[name="action"]:checked').val();

        let deviceName = deviceType;
        let displayName = '';
        let description = '';

        if (deviceType === '__new__') {
            deviceName = $('#newDeviceName').val().trim();
            displayName = $('#newDeviceDisplay').val().trim();
            description = $('#deviceDescription').val().trim();
        }

        if (!deviceName || selectedFiles.length === 0) {
            alert('Please select a device and files to upload.');
            return;
        }

        // Show progress
        $('#progressContainer').show();
        $('#uploadActions').hide();
        $('#resultsContainer').hide();

        // Create form data
        const formData = new FormData();
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });
        formData.append('device_type', deviceType);
        formData.append('action', action);

        if (deviceType === '__new__') {
            formData.append('new_device_name', deviceName);
            formData.append('new_device_display', displayName);
            formData.append('description', description);
        }

        // Upload files
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        updateProgress(percentComplete);
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                if (response.success) {
                    showResults(response);
                } else {
                    showError(response.error || 'Upload failed');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Upload failed';
                showError(error);
            }
        });
    }

    function updateProgress(percent) {
        const progressBar = $('#progressBarFill');
        progressBar.css('width', percent + '%');
        progressBar.text(Math.round(percent) + '%');
    }

    function showResults(response) {
        $('#progressContainer').hide();
        $('#resultsContainer').show();

        const resultsList = $('#resultsList');
        resultsList.empty();

        // Success message
        resultsList.append(`
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle"></i> Upload Successful!</h6>
                <p>Files uploaded to device: <strong>${response.device_name}</strong></p>
                <p>Action: <strong>${response.action}</strong></p>
            </div>
        `);

        // Success files
        if (response.results.success_files && response.results.success_files.length > 0) {
            const successHtml = response.results.success_files.map(file =>
                `<div class="result-item success">
                    <i class="fas fa-check"></i> ${file.filename}
                    (${file.mib_name}, ${file.nodes_count} nodes)
                </div>`
            ).join('');

            resultsList.append(`
                <h6>Successfully Processed (${response.results.success_count}):</h6>
                ${successHtml}
            `);
        }

        // Errors
        if (response.results.errors && response.results.errors.length > 0) {
            const errorHtml = response.results.errors.map(error =>
                `<div class="result-item error">
                    <i class="fas fa-exclamation-triangle"></i> ${error.filename}: ${error.error}
                </div>`
            ).join('');

            resultsList.append(`
                <h6>Errors (${response.results.error_count}):</h6>
                ${errorHtml}
            `);
        }
    }

    function showError(message) {
        $('#progressContainer').hide();
        $('#uploadActions').show();

        alert('Upload Error: ' + message);
    }
});
</script>
{% endblock %}