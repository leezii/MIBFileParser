# 任务清单: 添加单元测试

## 任务顺序

### 第一阶段: 测试基础设施

- [x] **T1: 配置 pytest 测试框架**
  - 创建 `tests/conftest.py` 配置文件
  - 配置 pytest 标记（markers）用于分离快慢测试
  - 设置 pytest.ini 或 pyproject.toml 测试配置
  - 验证 `uv run pytest` 可以正常运行
  - **验证**: 运行 `pytest --collect-only` 无错误
  - **依赖**: 无
  - **状态**: ✅ 完成

- [x] **T2: 创建测试目录结构**
  - 创建 `tests/fixtures/mibs/` 用于测试 MIB 文件
  - 创建 `tests/unit/` 用于单元测试
  - 创建 `tests/integration/` 用于集成测试
  - 创建 `tests/api/` 用于 API 测试
  - 添加 `__init__.py` 文件使目录成为包
  - **验证**: 目录结构符合 pytest 最佳实践
  - **依赖**: T1
  - **状态**: ✅ 完成

- [x] **T3: 创建基础测试夹具（fixtures）**
  - 创建 `tests/fixtures/mibs/` 小型测试 MIB 文件
    - `simple.mib`: 简单的 MIB 定义
    - `table.mib`: 包含表格的 MIB
    - `nested.mib`: 嵌套结构的 MIB
  - 创建 `conftest.py` 中的共享 fixtures:
    - `sample_mib_node()`: 示例 MIB 节点
    - `sample_mib_data()`: 示例 MIB 数据
    - `sample_index_field()`: 示例索引字段
    - `temp_directory()`: 临时目录 fixture
  - **验证**: fixtures 可以被测试导入和使用
  - **依赖**: T2

- [x] **T4: 配置代码覆盖率报告**
  - 配置 pytest-cov 生成覆盖率报告
  - 设置覆盖率目标（初期 60%）
  - 配置 HTML 报告生成到 `htmlcov/`
  - 添加 `.coveragerc` 配置文件排除不需要测试的文件
  - **验证**: 运行 `pytest --cov` 生成覆盖率报告
  - **状态**: ✅ 完成
  - **依赖**: T1

### 第二阶段: 核心模型测试

- [x] **T5: 测试 IndexField 模型**
  - 创建 `tests/unit/test_models/test_index_field.py`
  - 测试 `IndexField` 初始化
  - 测试 `to_dict()` 序列化方法
  - 测试 `from_dict()` 反序列化方法
  - 测试边界情况（空值、特殊字符）
  - **验证**: 所有测试通过，覆盖率 > 80%
  - **依赖**: T3

- [x] **T6: 测试 MibNode 模型**
  - 创建 `tests/unit/test_models/test_mib_node.py`
  - 测试 `MibNode` 初始化和属性
  - 测试 `to_dict()` 序列化方法
  - 测试 `from_dict()` 反序列化方法
  - 测试特殊 OID 处理（长 OID、嵌套）
  - **验证**: 所有测试通过，覆盖率 > 80%
  - **依赖**: T3

- [x] **T7: 测试 MibData 模型**
  - 创建 `tests/unit/test_models/test_mib_data.py`
  - 测试 `MibData` 初始化
  - 测试 `add_node()` 添加节点方法
  - 测试 `get_node_by_oid()` OID 查询
  - 测试 `get_node_by_name()` 名称查询
  - 测试 `get_root_nodes()` 获取根节点
  - 测试 `get_children()` 获取子节点
  - 测试 `get_descendants()` 获取后代节点
  - 测试边界情况（空数据、重复节点、不存在的节点）
  - **验证**: 所有测试通过，覆盖率 > 80%
  - **依赖**: T3

### 第三阶段: 验证和文档

- [x] **T8: 运行完整测试套件并生成报告**
  - 运行 `pytest -v` 显示详细输出
  - 运行 `pytest --cov=src` 生成覆盖率报告
  - 运行 `pytest --cov-report=html` 生成 HTML 报告
  - 检查覆盖率是否达到 60% 目标
  - **验证**: 测试套件全部通过，覆盖率达标
  - **状态**: ✅ 完成（55个测试，models.py覆盖率97.09%）
  - **依赖**: T5, T6, T7

- [x] **T9: 编写测试文档**
  - 创建 `tests/README.md` 说明测试结构
  - 文档说明如何运行测试
  - 文档说明测试夹具使用方法
  - 文档说明覆盖率目标和查看方法
  - **验证**: 文档清晰完整，新开发者可理解
  - **状态**: ✅ 完成
  - **依赖**: T8

- [x] **T10: 代码审查和重构**
  - 审查所有测试代码质量
  - 重构重复的测试代码
  - 提取公共测试辅助函数
  - 确保测试命名清晰
  - **验证**: 代码符合项目规范（black, flake8, mypy）
  - **状态**: ✅ 完成（所有检查通过）
  - **依赖**: T9

## 可并行化任务组

### 组 1: 可以并行执行
- T5 (IndexField 测试) || T6 (MibNode 测试)

### 组 2: 需要等待前面任务完成
- T7 (MibData 测试) 必须在 T5, T6 之后（可能需要共享测试逻辑）

## 里程碑

### 里程碑 1: 测试基础设施就绪
- **完成条件**: T1-T4 全部完成
- **交付物**: 可运行的测试框架，基础夹具就绪

### 里程碑 2: 核心模型测试完成
- **完成条件**: T5-T7 全部完成
- **交付物**: models.py 完整测试套件，覆盖率 > 60%

### 里程碑 3: 第一阶段完成
- **完成条件**: T1-T10 全部完成
- **交付物**: 完整的测试基础设施和核心模型测试，文档齐全

## 验收标准

### 功能验收
- ✅ 所有测试可以重复运行且结果稳定
- ✅ 测试覆盖了核心模块的主要功能
- ✅ 测试覆盖率达到 60% 以上
- ✅ 测试文档完整清晰

### 质量验收
- ✅ 测试代码通过 black, flake8, mypy 检查
- ✅ 测试命名清晰，易于理解
- ✅ 测试失败时错误信息明确
- ✅ 无多余的硬编码值

### 工程验收
- ✅ 测试运行时间 < 30 秒（不含慢速测试）
- ✅ 测试夹具可复用
- ✅ 测试与实现代码分离
- ✅ 代码审查通过

## 风险和应对

| 风险 | 应对措施 |
|------|----------|
| T3 创建测试 MIB 文件困难 | 先创建极简的 10-20 行 MIB 文件，后续扩展 |
| T7 MibData 测试复杂度高 | 拆分为多个小测试类，每个测试类专注一个方法 |
| 覆盖率无法达到 60% | 先测试核心功能，标记未测试部分为 TODO |
| 测试运行不稳定 | 检查 fixture 清理，确保测试隔离 |

## 后续任务（不在本提案范围）

- [ ] 解析器（`parser.py`）测试 - 第二阶段
- [ ] 树工具（`tree.py`）测试 - 第二阶段
- [ ] 叶节点提取器（`leaf_extractor.py`）测试 - 第二阶段
- [ ] 依赖解析器（`dependency_resolver.py`）测试 - 第二阶段
- [ ] 服务层测试（device_service, mib_service 等）- 第三阶段
- [ ] Flask API 路由测试 - 第三阶段
- [ ] 集成测试 - 第三阶段
- [ ] CI/CD 集成 - 第四阶段

---

**任务清单版本**: 1.0
**创建日期**: 2026-01-01
**预计总工时**: 5-8 小时
